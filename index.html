<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>hello phaser!</title>

        <!-- scripts -->
        <script src="js/phaser.min.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {
    	var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'container');
        
        var platformsGroup,
        	wallsGroup,
        	player,
        	Wall,
        	// config
        	wallCreationInterval = 2000,
        	gameSpeed = -150,
            elements = ['fire','water','plant'],
            oppositeElements = { 
            	'fire': { strongAgainst: 'plant' }, 
            	'water': { strongAgainst: 'fire' },
            	'plant': { strongAgainst: 'water' }
            };
    	
    	/*
    	 * PRELOAD
    	 * Load assets of the game
    	 */

    	var preload = function () {
	    	game.load.image('bk', 'img/sky.png');
	    	game.load.image('tower', 'img/tower.png');
	    	game.load.image('plateform', 'img/platform.png');
	    	game.load.image('wall-plant', 'img/wall.png');
	    	game.load.image('wall-fire', 'img/wall_fire.png');
	    	game.load.image('wall-water', 'img/wall_water.png');
	    	game.load.image('button_water', 'img/button_water.png');
	    	game.load.image('button_fire', 'img/button_fire.png');
	    	game.load.image('button_plant', 'img/button_plant.png');
	    	game.load.spritesheet('dude', 'img/dude.png', 32, 48);
	    }


	    /*
	     * INIT
	     * Create your objects 
	     */

    	var init = function () {
        	game.physics.startSystem(Phaser.Physics.ARCADE);

        	initBackground();
        	initWorldElements();
        	initPlayer();
        	initActionInputs();

        	// loop the creation of walls
		    game.time.events.loop(wallCreationInterval, createWalls);
        }

        var initBackground = function () {
        	game.add.sprite(0, 0, 'bk');

        	var backgroundGroup = game.add.group();
        	backgroundGroup.enableBody = true;

			var tower = backgroundGroup.create(800, 125, 'tower');
        	tower.scale.setTo(0.5, 0.5);
        	tower.body.gravity.x = -20;
        }

        var initWorldElements = function () {
        	platformsGroup = game.add.group();
        	platformsGroup.enableBody = true;

        	// walls will inherits properties of platforms
        	wallsGroup = game.add.group();
        	platformsGroup.add(wallsGroup);

	        // create the ground	
    		var ground = platformsGroup.create(0, game.world.height - 192, 'plateform');
    		//  original size: 400x32
    		ground.scale.setTo(2, 6);
    		//  This stops it from falling away when you jump on it
    		ground.body.immovable = true;

    		// create the ceiling
    		var ceiling = platformsGroup.create(0, 0, 'plateform');
    		ceiling.scale.setTo(2, 2);
        }

        var initPlayer = function () {
    		player = game.add.sprite(200, 300, 'dude');

    		game.physics.arcade.enable(player);
		    player.body.bounce.y = 0.2;
		    player.body.gravity.y = 300;
		    player.body.collideWorldBounds = true;

		    player.animations.add('run', [5, 6, 7, 8], 10, true);
        }

        var initActionInputs = function () {
		    buttons_fire = game.add.sprite(100, 450, 'button_fire');
		    buttons_water = game.add.sprite(300, 450, 'button_water');
		    buttons_plant = game.add.sprite(500, 450, 'button_plant');
		    
		    buttons_fire.inputEnabled = true;
			buttons_fire.events.onInputDown.add(equipHoodHandler, this);

		    buttons_water.inputEnabled = true;
			buttons_water.events.onInputDown.add(equipHoodHandler, this);

		    buttons_plant.inputEnabled = true; 
			buttons_plant.events.onInputDown.add(equipHoodHandler, this);
        }
    	

        /*
         * UPDATE
         *	
         */

	    var update = function () {
    		game.physics.arcade.collide(player, platformsGroup);
    		// callback for collision with walls
    		game.physics.arcade.collide(player, wallsGroup, onCollisionHandler);
		    
	        //  Always running
	        player.animations.loop = true;
	        player.animations.play('run');
    	}


    	/*
    	 * Handlers
    	 */

    	var equipHoodHandler = function (event) {
    		// extract element 'fire' from eg. 'button_fire'
    		var elementClicked = event.key.replace(/button_/i, '');
    		updatePlayerSkills(oppositeElements[elementClicked].strongAgainst);
        }


    	var updatePlayerSkills = function (elementStrongAgainst) {
    		player.resistance = elementStrongAgainst;

			console.log('Player has resistance against: ' + player.resistance);
    	}

    	var onCollisionHandler = function () {
    		// the player died
    		player.destroy();
    		startGame();
    	}


    	/*
    	 * WALL Object
		 */

        Wall = function (x, y, speed) {
        	// get random element
        	var wallElement = elements[game.rnd.integerInRange(0,2)];
        	this.element = wallElement;

			Phaser.Sprite.call(this, game, x, y, 'wall-' + wallElement);
			game.physics.enable(this, Phaser.Physics.ARCADE);
			this.body.gravity.x = speed;
            
            console.log('creation of a wall of element: ' + this.element);
        };
        
        Wall.prototype = Object.create(Phaser.Sprite.prototype);
        
        Wall.prototype.constructor = Wall;
        
        Wall.prototype.update = function () {
        	if (player.resistance === this.element) {
        		// disable collision
        		this.body.checkCollision.left = false;
        	}
		} 

        var createWalls = function () {
        	var wall = new Wall(800, 50, gameSpeed);
			game.add.existing(wall);
			wallsGroup.add(wall);
        }


        /*
       	 * GAME
       	 */

       	var play = function (game) {};

       	play.prototype = {
    		preload: preload,
	       	create: init,
        	update: update
    	}

       	game.state.add('Play', play);

       	var startGame = function () {
       		game.state.start('Play');
       	}
		
        game.state.add('Play', play);
        startGame();

        /*
         * Home Menu
         */

        // window.start = function() {
        //  	startGame();
        //  	$('#menu').style.display = 'none';
        // }
    };

    </script>

    <div style="height:600px;width:800px;"
    		id="container">
    </div>

    </body>
</html>